
@{
    ViewData["Title"] = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
    a#archivoCargado:hover {
        color: #AE0025 !important;
    }

    a.form-control:hover {
        color: #AE0025 !important;
    }

    /* Forzar que los campos de TinyMCE dialog sean editables */
    .tox-tinymce-aux {
        z-index: 10000 !important;
    }

    .tox-dialog {
        z-index: 10001 !important;
    }

    .tox-dialog-wrap {
        z-index: 10000 !important;
    }

    .tox-textfield, .tox-listbox, .tox-textarea {
        pointer-events: auto !important;
        user-select: text !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
    }

    .tox-textfield:focus, .tox-textarea:focus {
        outline: 2px solid #006ce7 !important;
        border-color: #006ce7 !important;
    }

    .tox-dialog__body-content input[type="url"],
    .tox-dialog__body-content input[type="text"],
    .tox-dialog__body-content textarea {
        pointer-events: auto !important;
        cursor: text !important;
    }

</style>
<h3>Gestión de Material</h3>

<div class="row text-center">
    <div class="col-6 col-md-3 col-lg-1 my-2 me-3">
        <div class="p-3 d-flex flex-column justify-content-center align-items-center rounded"
             style="background:#D9534F; width: 100px; height: 100px; border-radius: 10px; overflow: hidden; text-align: center;">
            <h2 data-bind="text:revision" style="margin: 0; word-wrap: break-word; max-width: 100%; font-size: 1.5em;"></h2>
            <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; margin: 0;">Revisión</p>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg-1 my-2 me-3">
        <div class="p-3 d-flex flex-column justify-content-center align-items-center rounded"
             style="background:#BA5C8F; width: 100px; height: 100px; border-radius: 10px; overflow: hidden; text-align: center;">
            <h2 data-bind="text:faltaInfo" style="margin: 0; word-wrap: break-word; max-width: 100%; font-size: 1.5em;"></h2>
            <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; margin: 0;">Falta Información</p>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg-1 my-2 me-3">
        <div class="p-3 d-flex flex-column justify-content-center align-items-center rounded"
             style="background:#9B59B6; width: 100px; height: 100px; border-radius: 10px; overflow: hidden; text-align: center;">
            <h2 data-bind="text:aprobado" style="margin: 0; word-wrap: break-word; max-width: 100%; font-size: 1.5em;"></h2>
            <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; margin: 0;">Aprobado</p>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg-1 my-2 me-3">
        <div class="p-3 d-flex flex-column justify-content-center align-items-center rounded"
             style="background:#C897A5; width: 100px; height: 100px; border-radius: 10px; overflow: hidden; text-align: center;">
            <h2 data-bind="text:programado" style="margin: 0; word-wrap: break-word; max-width: 100%; font-size: 1.5em;"></h2>
            <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; margin: 0;">Programado</p>
        </div>
    </div>
    <div class="col-6 col-md-3 col-lg-1 my-2 me-3">
        <div class="p-3 d-flex flex-column justify-content-center align-items-center rounded"
             style="background:#B8A49D; width: 100px; height: 100px; border-radius: 10px; overflow: hidden; text-align: center;">
            <h2 data-bind="text:entregado" style="margin: 0; word-wrap: break-word; max-width: 100%; font-size: 1.5em;"></h2>
            <p style="white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 12px; margin: 0;">Entregado</p>
        </div>
    </div>
   
</div>

<div class="row mb-3">
    <div class="col">
        <input type="text"
               class="form-control"
               placeholder="Buscar por Nombre"
               data-bind="value: filtroNombre, valueUpdate: 'input'" />
    </div>
    <div class="col">
        <input type="text"
               class="form-control"
               placeholder="Buscar por Area"
               data-bind="value: filtroArea, valueUpdate: 'input'" />
    </div>
    <div class="col">
        <input type="text"
               class="form-control"
               placeholder="Buscar por Responsable"
               data-bind="value: filtroResponsable, valueUpdate: 'input'" />
    </div>
</div>
<div class="row mb-3">
    <div class="col">
        <input type="text"
               class="form-control"
               placeholder="Buscar por nombre de proyecto"
               data-bind="value: filtroNombreProyecto, valueUpdate: 'input'" />
    </div>
    <div class="col">
        <!-- Fecha Inicio -->
        <input type="date"
               class="form-control"
               placeholder="Filtrar por fecha inicio"
               data-bind="value: filtroFechaInicio, valueUpdate: 'input'" />
    </div>
    <div class="col">
        <!-- Fecha Fin -->
        <input type="date"
               class="form-control"
               placeholder="Filtrar por fecha fin"
               data-bind="value: filtroFechaFin, valueUpdate: 'input'" />
    </div>
</div>
<!-- Botón para Exportar a Excel -->
<div class="row mb-3">
    <div class="col-4">
        <select id="filtroEstatusMateriales" class="form-control" data-bind="options: catEstatusMaterialesFiltro, value: EstatusMaterialesFiltro, optionsText: 'descripcion', optionsCaption: 'Seleccione Estatus'"></select>
    </div>
    <div class="col text-end">
        <button type="button" class="btn btn-success my-2" data-bind="click: exportarExcel">
            <i class="lni lni-download"></i> Exportar a Excel
        </button>
    </div>
</div>

<div class="row">
    <div class="col">
         <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th scope="col">Nombre de Material</th>
                        <th scope="col">Mensaje</th>
                        <th scope="col">PCN</th>
                        <th scope="col">Formato</th>
                        <th scope="col">Estatus</th>
                        <th scope="col">Nombre del proyecto</th>
                        <th scope="col">Audiencia</th>
                        <th scope="col">Responsable</th>
                        <th scope="col">Area</th>
                        <th scope="col">Fecha Entrega</th>
                        <th scope="col">Acciones</th>

                    </tr>
                </thead>
                <tbody data-bind="foreach: paginatedRegistros">
                    <tr>
                        <td data-bind="text: nombre"></td>
                        <td data-bind="text: mensaje"></td>
                        <td data-bind="text: $root.getPCNsString($data)"></td>
                        <td data-bind="text: formato.descripcion"></td>
                        <td data-bind="text: estatusMaterial.descripcion"></td>
                        <td data-bind="text: brief.nombre"></td>
                        <td data-bind="text: $root.getAudienciasString($data)"></td>
                        <td data-bind="text: responsable"></td>
                        <td data-bind="text: area"></td>
                        <td data-bind="text: new Date(fechaEntrega).toLocaleDateString('es-MX')"></td>
                        <td>
                            <button type="button" class="btn btn-sm btn-primary" data-bind="click:$root.Editar" title="Editar material">
                                <i class="lni lni-pencil"></i> Editar
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="pagination">
                <button class="btn btn-primary" data-bind="click: () => goToPage(currentPage() - 1), enable: currentPage() > 1">Anterior</button>
                <!-- Mostrar número de páginas -->
                <span data-bind="foreach: ko.utils.range(1, totalPages())">
                    <button class="btn btn-outline-secondary mx-3" data-bind="text: $data, click: () => $root.goToPage($data), css: { 'btn-primary': $data === $root.currentPage() }"></button>
                </span>
                <button class="btn btn-primary" data-bind="click: () => goToPage(currentPage() + 1), enable: currentPage() < totalPages()">Siguiente</button>
            </div>
        </div>
       
    </div>
</div>

<div class="modal fade" id="divEdicion" tabindex="-1" aria-labelledby="Modal" aria-hidden="true" data-bs-focus="false">
    <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="Modal" data-bind="text: tituloModal"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="background-color: rgba(0, 0, 0, .03);">
                <div class="row">
                    <!-- Información del Brief -->
                    <div class="col-12 mb-3">
                        <div class="card">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0"><i class="lni lni-folder"></i> Información del Proyecto (Brief)</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <!-- Información del Brief (Columna Izquierda) -->
                                    <div class="col-md-6">
                                        <h5 class="mb-3 text-primary">Información del Brief</h5>
                                        <p><strong>Nombre del Proyecto:</strong> <span data-bind="text: nombreBrief"></span></p>
                                        <p><strong>Estatus del Brief:</strong> <span data-bind="text: estatusBrief"></span></p>
                                        <p><strong>Fecha de Entrega del Brief:</strong> <span data-bind="text: fechaEntregaBrief"></span></p>
                                        <p><strong>Descripción:</strong> <span data-bind="text: descripcionBrief() || 'No disponible'"></span></p>
                                        <p><strong>Objetivo:</strong> <span data-bind="text: objetivoBrief() || 'No disponible'"></span></p>
                                        <p><strong>Dirigido A:</strong> <span data-bind="text: dirigidoABrief() || 'No disponible'"></span></p>
                                        <p><strong>Comentario:</strong> <span data-bind="text: comentarioBrief() || 'No disponible'"></span></p>
                                        <p><strong>Link de Referencia:</strong>
                                            <a data-bind="attr: { href: linksReferenciasNormalizadas }, text: linksReferencias || 'No disponible'" target="_blank"></a>
                                        </p>
                                        <p><strong>Archivo del Brief:</strong>
                                            <span data-bind="if: rutaArchivo() && rutaArchivo() !== ''">
                                                <a id="archivoCargado" data-bind="attr: { href: '/Brief/DownloadFile?id=' + idBrief() }, text: rutaArchivo()"></a>
                                            </span>
                                            <span data-bind="if: !rutaArchivo() || rutaArchivo() === ''">
                                                No hay archivo
                                            </span>
                                        </p>
                                    </div>

                                    <!-- Información del Material (Columna Derecha) -->
                                    <div class="col-md-6">
                                        <h5 class="mb-3 text-success">Información del Material</h5>
                                        <p><strong>Mensaje:</strong> <span data-bind="text: mensajeMaterial() || 'No disponible'"></span></p>
                                        <p><strong>PCN:</strong> <span data-bind="text: pcnMaterial() || 'No disponible'"></span></p>
                                        <p><strong>Formato:</strong> <span data-bind="text: formatoMaterial"></span></p>
                                        <p><strong>Estatus del Material:</strong> <span data-bind="text: estatusMaterial"></span></p>
                                        <p><strong>Audiencia:</strong> <span data-bind="text: audienciaMaterial"></span></p>
                                        <p><strong>Responsable:</strong> <span data-bind="text: responsableMaterial() || 'No disponible'"></span></p>
                                        <p><strong>Área:</strong> <span data-bind="text: areaMaterial() || 'No disponible'"></span></p>
                                        <p><strong>Fecha de Entrega:</strong> <span data-bind="text: fechaEntregaMaterial"></span></p>
                                        <!-- Fecha de Publicación - Solo visible si está liberada o si es Admin -->
                                        <p data-bind="visible: fechaPublicacionLiberada() || RolId === 1">
                                            <strong>Fecha de Publicación:</strong> <span data-bind="text: fechaPublicacionMaterial() || 'No definida'" style="color: #D9534F; font-weight: bold;"></span>
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h3>Historial de Comentarios</h3>
                    <div class="col-4" style="background-color:#FFFFFF;max-height: 400px; overflow-y: auto;">

                        <div data-bind="foreach: registrosHistorico">
                            <div class="card mb-3 shadow-sm">
                                <div class="card-header bg-light">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong data-bind="text: usuario.nombre + ' ' + usuario.apellidoPaterno"></strong>
                                            <span class="badge bg-secondary ms-2" data-bind="text: usuario.userRol ? usuario.userRol.descripcion : 'Participante'"></span>
                                        </div>
                                        <small class="text-muted" data-bind="text: new Date(fechaRegistro).toLocaleString('es-MX')"></small>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div data-bind="html: comentarios"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Mensaje cuando no hay comentarios -->
                        <div data-bind="if: registrosHistorico().length === 0" class="text-center text-muted p-4">
                            <p>No hay comentarios registrados aún.</p>
                        </div>
                    </div>
                    
                    
                    <div class="col">
                        <div id="formulario" class="p-3">
                            <h1>Agregar Entrada a Bitácora</h1>

                            <div class="mb-3" data-bind="validationElement: EstatusMateriales">
                                <label class="col-form-label">Clasificación:</label>
                                <select class="form-control" data-bind="options: catEstatusMateriales, value: EstatusMateriales, optionsText: 'descripcion', optionsCaption: 'Seleccione', disable: RolId === 2"></select>
                            </div>
                           <!-- <div class="mb-3" data-bind="validationElement: Comentario">
                                <label for="comentario-editor" class="col-form-label">Comentario:</label>
                                <div id="comentario-editor" class="form-control" contenteditable="true" style="min-height: 100px; border: 1px solid #ccc;" maxlength="128"></div>

                            </div>-->
                            <div class="mb-3">
                                <label class="form-label">Comentario</label>
                                <textarea id="myComentario"></textarea>
                            </div>
                            <div class="mb-3" data-bind="validationElement: fechaEntrega, visible:isRoleVisible([1])">
                                <label for="recipient-name" class="col-form-label">Cambiar Fecha Entrega:</label>
                                <input type="date" class="form-control" id="fechaEntrega" data-bind="value: fechaEntrega, attr: { min: minDate }">
                            </div>
                            <div class="mb-3" data-bind="validationElement: envioCorreo">
                                <label for="recipient-name" class="col-form-label">Notifica por Correo:</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="envioCorreoOptions" id="envioCorreo1" value="Sí" data-bind="checked: envioCorreo">
                                    <label class="form-check-label" for="envioCorreo1">Sí</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="envioCorreoOptions" id="envioCorreo2" value="No" data-bind="checked: envioCorreo">
                                    <label class="form-check-label" for="envioCorreo2">No</label>
                                </div>
                            </div>

                            <!-- Liberar Fecha de Publicación - Solo visible para Administrador -->
                            <div class="mb-3" data-bind="visible: isRoleVisible([1])">
                                <label for="liberarFechaPublicacion" class="col-form-label">Liberar Fecha de Publicación:</label>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="liberarFechaOptions" id="liberarFecha1" value="true" data-bind="checked: fechaPublicacionLiberada">
                                    <label class="form-check-label" for="liberarFecha1">Sí</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="liberarFechaOptions" id="liberarFecha2" value="false" data-bind="checked: fechaPublicacionLiberada">
                                    <label class="form-check-label" for="liberarFecha2">No</label>
                                </div>
                            </div>

                            <!-- Fecha de Publicación - Solo visible para Administrador -->
                            <div class="mb-3" data-bind="visible: isRoleVisible([1])">
                                <label for="fechaPublicacion" class="col-form-label">Fecha de Publicación:</label>
                                <input type="date" class="form-control" id="fechaPublicacion" data-bind="value: fechaPublicacion">
                            </div>

                            <div>
                                <h2 style="color:#FFAA16;">Participantes</h2>
                                <div>
                                    <label for="buscarUsuario">Buscar participante:</label>
                                    <input id="buscarUsuario" type="text" class="form-control" placeholder="Escribe el nombre del participante..."
                                           data-bind="value: buscarUsuario, valueUpdate: 'input', event: { keyup: buscarUsuarios }" />
                                    <ul data-bind="foreach: resultadosBusqueda" class="autocomplete-results" style="background-color:#fff">
                                        <li data-bind="text: nombre, click: $root.seleccionarUsuario"></li>
                                    </ul>
                                </div>
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th scope="col">Id</th>
                                            <th scope="col">Nombre</th>
                                            <th scope="col">Detalles</th>

                                        </tr>
                                    </thead>
                                    <tbody data-bind="foreach: registrosUsuariosCorreo">
                                        <tr>
                                            <td data-bind="text: id"></td>
                                            <td data-bind="text: nombre"></td>
                                            <td class="small">
                                                <button type="button" class="btn btn-outline-danger btn-sm" data-bind="click:$root.EliminarParticipante">
                                                    <i class="lni lni-trash-can"></i>
                                                    <span>Eliminar</span>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                        </div>
           
                    </div>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" data-bind="click:GuardarComentario">
                    <i class="lni lni-comment-plus"></i>
                    <span>Agregar Comentario</span>
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {

    <script src="~/js/tinymce/tinymce.min.js"></script>
    <script>
        // Pasar los valores de ViewBag a variables JavaScript
        var RolId = @Html.Raw(ViewBag.RolId);
        var FiltroNombreInicial = '@ViewBag.FiltroNombre';

    </script>
    <script>
        function initTinyMCE() {
            // Remover instancia existente si existe
            if (tinymce.get('myComentario')) {
                tinymce.get('myComentario').remove();
            }

            // Agregar traducciones al español para TinyMCE
            tinymce.addI18n('es', {
                'Insert/edit link': 'Insertar/editar enlace',
                'Text to display': 'Texto a mostrar',
                'Url': 'URL',
                'Title': 'Título',
                'Target': 'Destino',
                'None': 'Ninguno',
                'New window': 'Nueva ventana',
                'Remove link': 'Eliminar enlace',
                'Anchors': 'Anclas',
                'Link...': 'Enlace...',
                'Paste or type a link': 'Pegar o escribir un enlace',
                'The URL you entered seems to be an external link. Do you want to add the required https:// prefix?': 'La URL que ingresó parece ser un enlace externo. ¿Desea agregar el prefijo https:// requerido?',
                'The URL you entered seems to be an email address. Do you want to add the required mailto: prefix?': 'La URL que ingresó parece ser un correo electrónico. ¿Desea agregar el prefijo mailto: requerido?',
                'Cancel': 'Cancelar',
                'Save': 'Guardar',
                'Ok': 'Aceptar',
                'Yes': 'Sí',
                'No': 'No'
            });

            tinymce.init({
                selector: '#myComentario',
                license_key: 'gpl',
                language: 'es',
                plugins: 'lists link image table code',
                toolbar: 'undo redo | bold italic underline | alignleft aligncenter alignright | bullist numlist outdent indent | link image | code',
                height: 300,
                menubar: false,
                promotion: false,
                branding: false,
                // Configuración del plugin link para habilitar todos los campos
                link_default_target: '_blank',
                link_default_protocol: 'https',
                link_assume_external_targets: true,
                link_title: true,
                link_quicklink: false,
                convert_urls: false,
                relative_urls: false,
                target_list: [
                    { title: 'Nueva ventana', value: '_blank' },
                    { title: 'Misma ventana', value: '_self' }
                ],
                images_upload_url: '/Materiales/upload',
                automatic_uploads: true,
                images_upload_handler: function (blobInfo, progress) {
                    return new Promise(function(resolve, reject) {
                        var xhr = new XMLHttpRequest();
                        xhr.withCredentials = false;
                        xhr.open('POST', '/Materiales/upload');

                        xhr.upload.onprogress = function (e) {
                            progress(e.loaded / e.total * 100);
                        };

                        xhr.onload = function() {
                            if (xhr.status === 403) {
                                reject({ message: 'HTTP Error: ' + xhr.status, remove: true });
                                return;
                            }

                            if (xhr.status < 200 || xhr.status >= 300) {
                                reject('HTTP Error: ' + xhr.status);
                                return;
                            }

                            try {
                                var json = JSON.parse(xhr.responseText);
                                if (!json || typeof json.location !== 'string') {
                                    reject('Invalid JSON: ' + xhr.responseText);
                                    return;
                                }
                                resolve(json.location);
                            } catch (e) {
                                reject('Error parsing response: ' + e.message);
                            }
                        };

                        xhr.onerror = function () {
                            reject('Image upload failed due to a XHR Transport error. Code: ' + xhr.status);
                        };

                        var formData = new FormData();
                        formData.append('file', blobInfo.blob(), blobInfo.filename());
                        xhr.send(formData);
                    });
                },
                setup: function (editor) {
                    editor.on('init', function () {
                        console.log('TinyMCE initialized and ready');
                        // Forzar que el editor sea editable
                        editor.mode.set('design');
                        setTimeout(function() {
                            editor.focus();
                        }, 100);
                    });
                }
            });
        }

        $(document).ready(function () {
            // Prevenir que Bootstrap modal capture el foco de los diálogos de TinyMCE
            $(document).on('focusin', function(e) {
                if ($(e.target).closest(".tox-tinymce-aux, .tox-dialog, .tox-dialog-wrap, .moxman-window, .tam-assetmanager-root").length) {
                    e.stopImmediatePropagation();
                }
            });

            // También prevenir en mousedown para asegurar que el clic funcione
            $(document).on('mousedown', function(e) {
                if ($(e.target).closest(".tox-tinymce-aux, .tox-dialog, .tox-dialog-wrap").length) {
                    e.stopPropagation();
                }
            });

            // Deshabilitar el enfoque forzado del modal de Bootstrap cuando hay diálogos de TinyMCE
            var observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.addedNodes.length) {
                        var tinyDialog = document.querySelector('.tox-dialog-wrap');
                        var bsModal = bootstrap.Modal.getInstance(document.getElementById('divEdicion'));
                        if (tinyDialog && bsModal) {
                            // Forzar que los inputs sean clickeables
                            var inputs = tinyDialog.querySelectorAll('input, textarea');
                            inputs.forEach(function(input) {
                                input.removeAttribute('tabindex');
                                input.style.pointerEvents = 'auto';
                            });
                        }
                    }
                });
            });

            observer.observe(document.body, { childList: true, subtree: true });

            // Inicializar TinyMCE cuando se abre el modal
            $('#divEdicion').on('shown.bs.modal', function () {
                initTinyMCE();
            });

            // Limpiar TinyMCE cuando se cierra el modal
            $('#divEdicion').on('hidden.bs.modal', function () {
                if (tinymce.get('myComentario')) {
                    tinymce.get('myComentario').remove();
                }
            });
        });
    </script>
    <script src="~/js/Material/Material.js?v=@DateTime.Now.Ticks" asp-append-version="true"></script>
}
