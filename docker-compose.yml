version: '3.8'

services:
  # ═══════════════════════════════════════════════════════════
  # SQL SERVER - Base de datos
  # ═══════════════════════════════════════════════════════════
  adminproyectos-sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: local-adminproyectos-sqlserver
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1536M
        reservations:
          cpus: '0.5'
          memory: 512M

    environment:
      - ACCEPT_EULA=Y
      - SA_PASSWORD=Operaciones.2025
      - MSSQL_PID=Express  # Express Edition (gratis, hasta 10GB)

    ports:
      - "1433:1433"  # Exponer puerto SQL Server para conexiones externas si necesitas

    volumes:
      - sqlserver-data:/var/opt/mssql
      - ./backups:/backups

    healthcheck:
      test: /opt/mssql-tools18/bin/sqlcmd -S localhost -No -U sa -P "Operaciones.2025" -Q "SELECT 1" || exit 1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 90s

  # ═══════════════════════════════════════════════════════════
  # APLICACIÓN WEB - AdminProyectos
  # ═══════════════════════════════════════════════════════════
  adminproyectos-web:
    build:
      context: .
      dockerfile: PresentationLayer/Dockerfile
    container_name: local-adminproyectos-web
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1024M
        reservations:
          cpus: '0.25'
          memory: 256M

    depends_on:
      adminproyectos-sqlserver:
        condition: service_healthy

    environment:
      # ASP.NET Core
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ASPNETCORE_HTTPS_PORT=443

      # Base de datos
      - ConnectionStrings__DefaultConnection=Server=adminproyectos-sqlserver;Database=AdminProyectosNaturaDB;User Id=sa;Password=Operaciones.2025;TrustServerCertificate=True;

      # Logs
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft=Warning

      # File Storage
      - FileStorage__UploadPath=/app/uploads/Brief

      # Email - Gmail configurado
      - EmailSettings__SmtpServer=smtp.gmail.com
      - EmailSettings__SmtpPort=587
      - EmailSettings__SenderEmail=armando.cortes@entersys.mx
      - EmailSettings__Username=armando.cortes@entersys.mx
      - EmailSettings__Password=bjmg bjyr elnt ycnv
      - EmailSettings__UseSsl=true

    ports:
      - "8080:80"  # Acceder desde http://localhost:8080

    volumes:
      # Persistencia de archivos subidos
      - uploads-data:/app/wwwroot/uploads
      # Logs persistentes
      - logs-data:/app/Logs

    networks:
      - traefik
      - default

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP
      - "traefik.http.routers.adminproyectos-http.rule=Host(`adminproyectos.entersys.mx`)"
      - "traefik.http.routers.adminproyectos-http.entrypoints=web"
      - "traefik.http.routers.adminproyectos-http.middlewares=https-redirect"

      # HTTPS
      - "traefik.http.routers.adminproyectos.rule=Host(`adminproyectos.entersys.mx`)"
      - "traefik.http.routers.adminproyectos.entrypoints=websecure"
      - "traefik.http.routers.adminproyectos.tls=true"
      - "traefik.http.routers.adminproyectos.tls.certresolver=letsencrypt"

      # Service
      - "traefik.http.services.adminproyectos.loadbalancer.server.port=80"

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

# ═══════════════════════════════════════════════════════════
# VOLUMES - Persistencia de datos
# ═══════════════════════════════════════════════════════════
volumes:
  sqlserver-data:
    driver: local
  uploads-data:
    driver: local
  logs-data:
    driver: local

# ═══════════════════════════════════════════════════════════
# NETWORKS - Traefik
# ═══════════════════════════════════════════════════════════
networks:
  traefik:
    external: true
