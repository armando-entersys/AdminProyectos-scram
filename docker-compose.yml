version: '3.8'

services:
  # ═══════════════════════════════════════════════════════════
  # POSTGRESQL - Base de datos
  # ═══════════════════════════════════════════════════════════
  adminproyectos-postgres:
    image: postgres:16-alpine
    container_name: local-adminproyectos-postgres
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

    environment:
      - POSTGRES_USER=adminuser
      - POSTGRES_PASSWORD=Operaciones.2025
      - POSTGRES_DB=AdminProyectosNaturaDB
      - PGDATA=/var/lib/postgresql/data/pgdata

    ports:
      - "5432:5432"  # Exponer puerto PostgreSQL para conexiones externas

    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./backups:/backups

    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U adminuser -d AdminProyectosNaturaDB"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ═══════════════════════════════════════════════════════════
  # APLICACIÓN WEB - AdminProyectos
  # ═══════════════════════════════════════════════════════════
  adminproyectos-web:
    build:
      context: .
      dockerfile: PresentationLayer/Dockerfile
    container_name: local-adminproyectos-web
    restart: unless-stopped

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1024M
        reservations:
          cpus: '0.25'
          memory: 256M

    depends_on:
      adminproyectos-postgres:
        condition: service_healthy

    environment:
      # ASP.NET Core
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:80
      - ASPNETCORE_HTTPS_PORT=443

      # Base de datos - PostgreSQL
      - ConnectionStrings__DefaultConnection=Host=adminproyectos-postgres;Port=5432;Database=AdminProyectosNaturaDB;Username=adminuser;Password=Operaciones.2025;

      # Logs
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft=Warning

      # File Storage
      - FileStorage__UploadPath=/app/uploads/Brief

      # Email - Gmail configurado
      - EmailSettings__SmtpServer=smtp.gmail.com
      - EmailSettings__SmtpPort=587
      - EmailSettings__SenderEmail=armando.cortes@entersys.mx
      - EmailSettings__Username=armando.cortes@entersys.mx
      - EmailSettings__Password=bjmg bjyr elnt ycnv
      - EmailSettings__UseSsl=true

    ports:
      - "8080:80"  # Acceder desde http://localhost:8080

    volumes:
      # Persistencia de archivos subidos
      - uploads-data:/app/wwwroot/uploads
      # Logs persistentes
      - logs-data:/app/Logs

    networks:
      - traefik
      - default

    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=traefik"

      # HTTP
      - "traefik.http.routers.adminproyectos-http.rule=Host(`adminproyectos.entersys.mx`)"
      - "traefik.http.routers.adminproyectos-http.entrypoints=web"
      - "traefik.http.routers.adminproyectos-http.middlewares=https-redirect"

      # HTTPS
      - "traefik.http.routers.adminproyectos.rule=Host(`adminproyectos.entersys.mx`)"
      - "traefik.http.routers.adminproyectos.entrypoints=websecure"
      - "traefik.http.routers.adminproyectos.tls=true"
      - "traefik.http.routers.adminproyectos.tls.certresolver=letsencrypt"

      # Service
      - "traefik.http.services.adminproyectos.loadbalancer.server.port=80"

    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:80/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

# ═══════════════════════════════════════════════════════════
# VOLUMES - Persistencia de datos
# ═══════════════════════════════════════════════════════════
volumes:
  postgres-data:
    driver: local
  uploads-data:
    driver: local
  logs-data:
    driver: local

# ═══════════════════════════════════════════════════════════
# NETWORKS - Traefik
# ═══════════════════════════════════════════════════════════
networks:
  traefik:
    external: true
